---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import CrossSiteLinks from '../../../components/CrossSiteLinks.astro';
import { siteConfig } from '../../../../site.config';

const collectionMap: Record<string, string> = {
  astrology:'astrology-blog',tarot:'tarot-blog',numerology:'numerology-blog',dreams:'dreams-blog',
  personality:'personality-blog',manifest:'manifest-blog',quotes:'quotes-blog',pets:'pets-blog',
  recipes:'recipes-blog',ai:'ai-blog',travel:'travel-blog',diy:'diy-blog',garden:'garden-blog',
};

export async function getStaticPaths() {
  return siteConfig.sites.map((site) => ({
    params: { site: site.slug },
    props: { site },
  }));
}

const { site } = Astro.props;
const collectionName = collectionMap[site.slug];
let posts: any[] = [];
if (collectionName) {
  try { posts = await getCollection(collectionName as any); } catch {}
}
const sortedPosts = posts.sort((a: any, b: any) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

const categories: Record<string, typeof posts> = {};
sortedPosts.forEach((post: any) => {
  const cat = post.data.category || 'general';
  if (!categories[cat]) categories[cat] = [];
  categories[cat].push(post);
});

const title = `${site.name} Blog â€” Expert Guides & Articles`;
const description = `Expert ${site.name.toLowerCase()} articles, guides, and tips. Free content updated regularly.`;
const formatDate = (d: Date) => d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

const breadcrumbLd = {
  '@context': 'https://schema.org', '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: siteConfig.url },
    { '@type': 'ListItem', position: 2, name: site.name, item: `${siteConfig.url}/${site.slug}/` },
    { '@type': 'ListItem', position: 3, name: 'Blog', item: `${siteConfig.url}/${site.slug}/blog/` },
  ],
};
---
<BaseLayout title={title} description={description} jsonLd={breadcrumbLd}>
  <div class="max-w-4xl mx-auto px-4 py-12">
    <nav class="text-sm text-gray-400 mb-8">
      <a href="/" class="hover:text-white">Home</a><span class="mx-2">/</span>
      <a href={`/${site.slug}/`} class="hover:text-white">{site.name}</a><span class="mx-2">/</span>
      <span class="text-white">Blog</span>
    </nav>
    <h1 class="text-3xl md:text-4xl font-display font-bold mb-3">{site.emoji} {site.name} Blog</h1>
    <p class="text-gray-400 mb-10">{sortedPosts.length} expert articles on {site.name.toLowerCase()}.</p>

    {sortedPosts.length > 0 ? (
      <div class="grid gap-3">
        {sortedPosts.map((post: any) => (
          <a href={`/${site.slug}/blog/${post.id}/`}
            class="group flex justify-between items-center gap-4 p-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl transition-colors">
            <div>
              <h3 class="font-semibold text-white group-hover:text-primary transition-colors">{post.data.title}</h3>
              <p class="text-sm text-gray-400 mt-1 line-clamp-1">{post.data.description}</p>
            </div>
            <time class="text-xs text-gray-500 whitespace-nowrap flex-shrink-0">{formatDate(post.data.publishDate)}</time>
          </a>
        ))}
      </div>
    ) : (
      <p class="text-gray-400">Articles coming soon! Check back for expert guides about {site.name.toLowerCase()}.</p>
    )}
    <CrossSiteLinks currentSite={site.slug} />
  </div>
</BaseLayout>
