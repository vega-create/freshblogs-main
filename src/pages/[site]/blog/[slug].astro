---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ShareButtons from '../../../components/ShareButtons.astro';
import CrossSiteLinks from '../../../components/CrossSiteLinks.astro';
import { siteConfig } from '../../../../site.config';

const collectionMap: Record<string, string> = {
  astrology:'astrology-blog',tarot:'tarot-blog',numerology:'numerology-blog',dreams:'dreams-blog',
  personality:'personality-blog',manifest:'manifest-blog',quotes:'quotes-blog',pets:'pets-blog',
  recipes:'recipes-blog',ai:'ai-blog',travel:'travel-blog',diy:'diy-blog',garden:'garden-blog',
};

export async function getStaticPaths() {
  const paths: any[] = [];
  for (const site of siteConfig.sites) {
    const col = collectionMap[site.slug];
    if (!col) continue;
    try {
      const posts = await getCollection(col as any);
      posts.forEach((post: any) => {
        paths.push({ params: { site: site.slug, slug: post.id }, props: { post, site } });
      });
    } catch {}
  }
  return paths;
}

const { post, site } = Astro.props;
const { Content, headings } = await render(post);
const { title, description, publishDate, updatedDate, author, tags, faq, image, category } = post.data;

const authorData = siteConfig.authors.find((a: any) => a.slug === author || a.sites.includes(site.slug)) || siteConfig.authors[0];
const pageUrl = `${siteConfig.url}/${site.slug}/blog/${post.id}/`;
const publishDateISO = publishDate.toISOString();
const updatedDateISO = updatedDate ? updatedDate.toISOString() : publishDateISO;
const tocItems = headings.filter((h: any) => h.depth === 2 || h.depth === 3);

const articleLd = {
  '@context': 'https://schema.org', '@type': 'Article', headline: title, description,
  datePublished: publishDateISO, dateModified: updatedDateISO,
  author: { '@type': 'Person', name: authorData.name, url: `${siteConfig.url}/about/${authorData.slug}/` },
  publisher: { '@type': 'Organization', name: siteConfig.name, url: siteConfig.url },
  mainEntityOfPage: pageUrl,
};
const breadcrumbLd = {
  '@context': 'https://schema.org', '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: siteConfig.url },
    { '@type': 'ListItem', position: 2, name: site.name, item: `${siteConfig.url}/${site.slug}/` },
    { '@type': 'ListItem', position: 3, name: 'Blog', item: `${siteConfig.url}/${site.slug}/blog/` },
    { '@type': 'ListItem', position: 4, name: title, item: pageUrl },
  ],
};
const faqLd = faq && faq.length > 0 ? {
  '@context': 'https://schema.org', '@type': 'FAQPage',
  mainEntity: faq.map((item: {q: string; a: string}) => ({
    '@type': 'Question', name: item.q,
    acceptedAnswer: { '@type': 'Answer', text: item.a },
  })),
} : null;
const jsonLdArray = [articleLd, breadcrumbLd, ...(faqLd ? [faqLd] : [])];

const colName = collectionMap[site.slug];
let allPosts: any[] = [];
try { allPosts = await getCollection(colName as any); } catch {}
const relatedPosts = allPosts.filter((p: any) => p.id !== post.id).sort(() => Math.random() - 0.5).slice(0, 4);
const internalLinks = allPosts.filter((p: any) => p.id !== post.id).sort(() => Math.random() - 0.5).slice(0, 6);

const formatDate = (d: Date) => d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
---
<BaseLayout title={title} description={description} ogType="article" jsonLd={jsonLdArray}>
  <article class="max-w-3xl mx-auto px-4 py-12">
    <nav class="text-sm text-gray-400 mb-6">
      <a href="/" class="hover:text-white">Home</a><span class="mx-2">/</span>
      <a href={`/${site.slug}/`} class="hover:text-white">{site.name}</a><span class="mx-2">/</span>
      <a href={`/${site.slug}/blog/`} class="hover:text-white">Blog</a><span class="mx-2">/</span>
      <span class="text-white line-clamp-1">{title}</span>
    </nav>
    {tags && tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.slice(0, 5).map((tag: string) => (
          <span class="text-xs px-2 py-1 bg-primary/20 text-primary rounded-full">{tag}</span>
        ))}
      </div>
    )}
    <h1 class="text-3xl md:text-4xl font-display font-bold mb-4 leading-tight">{title}</h1>
    <div class="flex items-center gap-4 text-sm text-gray-400 mb-8 pb-6 border-b border-white/10">
      <a href={`/about/${authorData.slug}/`} class="flex items-center gap-2 hover:text-white transition-colors">
        <div class="w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center text-sm">{authorData.name.charAt(0)}</div>
        <span>{authorData.name}</span>
      </a>
      <time datetime={publishDateISO}>{formatDate(publishDate)}</time>
    </div>
    {tocItems.length > 2 && (
      <nav class="mb-8 p-5 bg-white/5 rounded-xl border border-white/10">
        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">üìë Table of Contents</h2>
        <ul class="space-y-1.5 text-sm">
          {tocItems.map((h: any) => (
            <li class={h.depth === 3 ? 'ml-4' : ''}>
              <a href={`#${h.slug}`} class="text-gray-300 hover:text-primary transition-colors">
                {h.depth === 3 ? '‚Üí ' : ''}{h.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    )}
    <div class="prose prose-invert prose-lg max-w-none
      prose-headings:font-display prose-headings:text-white prose-headings:scroll-mt-20
      prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4
      prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
      prose-p:text-gray-300 prose-p:leading-relaxed
      prose-a:text-purple-400 prose-a:hover:text-purple-300
      prose-strong:text-white prose-li:text-gray-300
      prose-blockquote:border-primary prose-blockquote:text-gray-400">
      <Content />
    </div>
    {internalLinks.length > 0 && (
      <div class="mt-10 p-5 bg-gradient-to-r from-primary/10 to-pink-500/10 rounded-xl border border-primary/20">
        <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">üìñ More {site.name} Articles</h3>
        <div class="grid sm:grid-cols-2 gap-2">
          {internalLinks.map((link: any) => (
            <a href={`/${site.slug}/blog/${link.id}/`} class="text-sm text-purple-400 hover:text-white transition-colors">‚Üí {link.data.title}</a>
          ))}
        </div>
      </div>
    )}
    {faq && faq.length > 0 && (
      <section class="mt-10 p-6 bg-white/5 rounded-xl border border-white/10">
        <h2 class="text-xl font-display font-bold mb-4" id="faq">‚ùì Frequently Asked Questions</h2>
        <div class="space-y-4">
          {faq.map((item: {q: string; a: string}) => (
            <details class="group" open>
              <summary class="cursor-pointer font-semibold text-white hover:text-primary transition-colors list-none flex items-center justify-between gap-2">
                <span>{item.q}</span>
                <span class="text-gray-500 group-open:rotate-180 transition-transform flex-shrink-0">‚ñæ</span>
              </summary>
              <p class="mt-2 text-gray-400">{item.a}</p>
            </details>
          ))}
        </div>
      </section>
    )}
    <ShareButtons title={title} url={pageUrl} />
    <div class="mt-10 p-6 bg-white/5 rounded-xl border border-white/10 flex items-start gap-4">
      <div class="w-14 h-14 bg-primary/20 rounded-full flex items-center justify-center text-xl flex-shrink-0">{authorData.name.charAt(0)}</div>
      <div>
        <a href={`/about/${authorData.slug}/`} class="font-bold text-white hover:text-primary transition-colors">{authorData.name}</a>
        <p class="text-sm text-primary/80">{authorData.role}</p>
        <p class="text-sm text-gray-400 mt-1 line-clamp-2">{authorData.bio}</p>
      </div>
    </div>
    {relatedPosts.length > 0 && (
      <section class="mt-12">
        <h2 class="text-xl font-display font-bold mb-4">Related Articles</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          {relatedPosts.map((rp: any) => (
            <a href={`/${site.slug}/blog/${rp.id}/`} class="p-4 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl transition-colors">
              <h3 class="font-semibold text-sm text-white hover:text-primary line-clamp-2">{rp.data.title}</h3>
              <p class="text-xs text-gray-500 mt-1">{formatDate(rp.data.publishDate)}</p>
            </a>
          ))}
        </div>
      </section>
    )}
    <CrossSiteLinks currentSite={site.slug} />
  </article>
</BaseLayout>
